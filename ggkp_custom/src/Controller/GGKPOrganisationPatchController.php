<?php

namespace Drupal\ggkp_custom\Controller;

use Drupal\node\Entity\Node;
use PhpOffice\PhpSpreadsheet\IOFactory;
use Drupal\taxonomy\Entity\Term;

/**
 * GGKP Organisation Patch.
  * Utility: Assign accidentally deleted term to node.
  * @param $termid
  * field organisation content ID
 */
class GGKPOrganisationPatchController {

  public function index(){
    $id_to_set = 10990;
    $nids = [
      439694,
      439564,
      439566,
      439457,
      439455,
      439286,
      439081,
      439035,
      439021,
      439018,
      438917,
      438786,
      438779,
      438754,
      438728,
      438720,
      438706,
      438669,
      438618,
      438479,
      438478,
      438476,
      438477,
      438341,
      438475,
      438271,
      438268,
      438245,
      438265,
      438237,
      438263,
      66919,
      69759,
      69758,
      69757,
      69832,
      69755,
      66842,
      69749,
      69743,
      69736,
      68952,
      70616,
      69830,
      69733,
      69731,
      70600,
      69730,
      69727,
      69722,
      69717,
      70592,
      68898,
      68895,
      68886,
      69709,
      69706,
      69827,
      66626,
      60371,
      69697,
      70557,
      68841,
      68823,
      69691,
      66506,
      69686,
      69687,
      69688,
      68788,
      69682,
      68758,
      69675,
      68742,
      70508,
      69823,
      68730,
      69672,
      68697,
      68693,
      69666,
      69667,
      69668,
      69664,
      69665,
      69663,
      68688,
      69658,
      69659,
      69656,
      69657,
      68687,
      69649,
      69638,
      68635,
      68630,
      66031,
      66032,
      68625,
      68618,
      68612,
      69617,
      68587,
      69614,
      68585,
      68565,
      68562,
      65598,
      65599,
      68529,
      68523,
      65482,
      65483,
      65484,
      68491,
      68492,
      68483,
      68480,
      68474,
      68459,
      68449,
      68433,
      68417,
      68409,
      68410,
      68411,
      67211,
      70391,
      69491,
      69492,
      69487,
      68399,
      68398,
      68383,
      68374,
      68371,
      64581,
      69374,
      68303,
      68301,
      68294,
      64167,
      68256,
      68241,
      68229,
      63902,
      68225,
      68224,
      68223,
      63847,
      68218,
      68216,
      68213,
      71961,
      68212,
      63635,
      68211,
      68209,
      68206,
      68205,
      67739,
      67740,
      67741,
      67742,
      67743,
      63504,
      63491,
      68199,
      68198,
      63403,
      63404,
      63405,
      63406,
      63407,
      63408,
      68196,
      68195,
      68193,
      63258,
      68192,
      63111,
      63112,
      62382,
      62383,
      62357,
      62363,
      62353,
      62354,
      62355,
      62356,
      62346,
      62347,
      62348,
      62349,
      62350,
      62336,
      62337,
      62338,
      62339,
      62340,
      62341,
      62342,
      62304,
    ];
    $nodes = Node::loadMultiple($nids);
    foreach ($nodes as $node) {
      if ($node->hasField('field_organisation')) {
        $current_orgs = $node->get('field_organisation')->getValue();
        // Add term if not exist.
        $index_to_add = array_search($id_to_set,array_column($current_orgs,'target_id'));
        if ($index_to_add === FALSE) {
          $node->get('field_organisation')->appendItem([
            'target_id' => $id_to_set,
          ]);
        }
        $node->save();
      }
    }
    return [
      '#type' => 'markup',
      '#markup' => "Term assign completed.",
    ];
  }

}
